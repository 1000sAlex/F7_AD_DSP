/*
 * fft.c
 *
 *  Created on: Dec 25, 2021
 *      Author: u
 */
#include "fft.h"

// @formatter:off
const float linear_20KHZ[128] =
    {
    0.163696725 ,0.158062793 ,0.369465279 ,0.403300021 ,0.321776078 ,0.323808441 ,0.524882456 ,0.74914132 ,0.820134542 ,0.756470529 ,0.836275488 ,1.039355167 ,1.180033463 ,1.239577858 ,1.210624679 ,1.109003938 ,1.120863534 ,0.991505939 ,1.056584621 ,0.934534129 ,0.870380836 ,0.851370713 ,0.8762017 ,1.051168654 ,1.188957336 ,1.240555957 ,1.274066383 ,1.108743242 ,0.975712402 ,0.91353743 ,0.765308089 ,0.731935715 ,0.67322206 ,0.661792304 ,0.653629954 ,0.695765415 ,0.60867128 ,0.542137213 ,0.565471017 ,0.514462669 ,0.551842021 ,0.545144909 ,0.594179107 ,0.637894746 ,0.647527972 ,0.64241266 ,0.625459985 ,0.672262507 ,0.654083172 ,0.678744244 ,0.717243575 ,0.688754928 ,0.664870842 ,0.711294488 ,0.771567765 ,0.865430046 ,0.89532911 ,0.907735518 ,0.978546421 ,0.980173265 ,1.046736296 ,1.025123614 ,1.075374772 ,1.057769399 ,1.154895629 ,1.098670801 ,1.099695442 ,1.272347923 ,1.231486619 ,1.266539675 ,1.281683084 ,1.358465942 ,1.348754289 ,1.314913228 ,1.343376175 ,1.351846876 ,1.387233456 ,1.282031462 ,1.277517267 ,1.425814314 ,1.396681596 ,1.313082893 ,1.352234447 ,1.316748674 ,1.416819991 ,1.331618789 ,1.428837852 ,1.34032218 ,1.409621563 ,1.48180765 ,1.453047982 ,1.525418418 ,1.62249527 ,1.536349756 ,1.612510684 ,1.623612306 ,1.549472323 ,1.660187874 ,1.667230028 ,1.697837923 ,1.755991716 ,2.031263458 ,2.156650091 ,2.233235677 ,2.290720617 ,2.723206553 ,2.981411979 ,4.487720029 ,8.96690827 ,10.76847888 ,11.88058879 ,12.61121324 ,13.13814415 ,13.59248919 ,13.95441938 ,14.29270833 ,14.55738812 ,14.83205582 ,15.0209992 ,15.21481855 ,15.36349756 ,15.56631601 ,15.66974668 ,15.77456104 ,15.88078704 ,15.98845339 ,15.98845339 ,16.04283588 ,
    };

const float linear_12KHZ[256] =
    {
    0.104955944, 0.178552051, 0.152869089, 0.16832018, 0.218856483, 0.276713573, 0.414368803, 0.548452668, 0.597426771, 0.687956864, 0.661313448, 0.614102129, 0.555240119, 0.52770861, 0.493028341, 0.431318479, 0.443696826, 0.456989121, 0.421389416, 0.390735063, 0.405915297, 0.477293394, 0.558084032, 0.600720539, 0.772760733, 0.826343276, 0.919302745, 0.997012868, 1.16504304, 1.140650315, 1.198608974, 1.217745892, 1.210018261, 1.141219218, 1.074750837, 1.087004528, 1.008437431, 1.034423387, 1.044814854, 0.979513926, 1.146364996, 1.260685692, 1.261380668, 1.289095511, 1.509330166, 1.591199257, 1.590093489, 1.637898734, 1.684937063, 1.605715461, 1.596751243, 1.541876369, 1.612504955, 1.754712064, 1.791812476, 1.583491025, 1.729512117, 1.641423624, 1.574772561, 1.536698812, 1.675069203, 1.458345782, 1.543957174, 1.559744057, 1.560808002, 1.539801165, 1.402908971, 1.439084611, 1.496497404, 1.477175295, 1.43637447, 1.496497404, 1.481958893, 1.499439404, 1.535667471, 1.311257611, 1.266267034, 1.260685692, 1.225572861, 1.244233024, 1.214514082, 1.237503803, 1.269780539, 1.099540861, 1.266968179, 1.321862814, 1.238173448, 1.306764438, 1.261380668, 1.303786058, 1.309007169, 1.529508377, 1.61935211, 1.720409422, 1.814547606, 1.754712064, 1.784824127, 1.834919432, 1.852748608, 2.103074018, 1.930923655, 1.864828469, 2.015986371, 1.962388106, 1.897300606, 2.06139147, 1.987962234, 1.840824241, 1.710122968, 1.707570546, 1.666529156, 1.510326423, 1.40033325, 1.415931022, 1.42386094, 1.37426098, 1.351532505, 1.36932647, 1.199237176, 1.140081979, 1.144072266, 1.184953149, 1.079313458, 1.006662794, 1.05883597, 1.066236967, 1.070727436, 1.003572163, 1.00977252, 0.93891856, 0.963835102, 0.923756371, 0.946296332, 0.958987649, 0.955783012, 1.015148417, 1.007105868, 0.931275755, 0.926374304, 0.965054631, 0.987972596, 1.052504384, 1.016501347, 0.923756371, 0.887565761, 0.899074472, 0.960194935, 0.855061484, 0.887565761, 0.928630086, 0.829639061, 0.823962741, 0.903690573, 0.904047622, 0.893457451, 0.844645453, 0.828137724, 0.860851968, 0.832355231, 0.823666138, 0.920782508, 0.978676018, 0.917091996, 0.859558426, 0.949437565, 0.980773481, 0.952599722, 1.014248462, 0.981614986, 1.01469824, 1.061784005, 1.129947917, 1.167420679, 1.12384309, 1.14751481, 1.079313458, 1.180673133, 1.069226416, 1.028841965, 1.155045195, 1.05590426, 1.060799505, 1.13330586, 1.15738216, 1.056879691, 0.965054631, 1.084428688, 1.075761416, 1.084942879, 1.045292157, 1.174009508, 1.149243863, 1.111829218, 1.128276396, 1.150978134, 1.13330586, 1.152137226, 1.090111735, 1.167420679, 1.172806013, 1.192984636, 1.153880248, 1.155628551, 1.192362966, 1.08033264, 1.148666933, 1.367689499, 1.251720203, 1.17884829, 1.096379747, 1.123291375, 1.182503634, 1.293467796, 1.286920434, 1.271898016, 1.387595228, 1.516331697, 1.516331697, 1.491619642, 1.693667307, 1.653283621, 1.682459214, 1.721703936, 1.732130607, 1.584587626, 1.586785389, 1.711402043, 1.757407474, 1.646147145, 1.518344082, 1.486773575, 1.499439404, 1.753367457, 1.702488491, 1.746675215, 1.721703936, 1.814547606, 1.626257663, 1.724298818, 1.967450156, 2.087723112, 2.093453368, 1.95234175, 2.059536032, 1.977653009, 1.982794221, 1.924427697, 2.008906524, 1.870927663, 1.993157257, 1.889466995, 1.914765298, 2.122583053, 2.381003675, 3.038704557, 3.425366065,
    };

const float linear_3KHZ[512] =
    {
    0.44166938, 0.524066696, 0.585911843, 0.572799545, 0.527797141, 0.464493403, 0.416122069, 0.34830956, 0.279513172, 0.25453891, 0.246872646, 0.246122255, 0.258259518, 0.273766168, 0.270598482, 0.265852198, 0.260898659, 0.255616539, 0.261128073, 0.250153411, 0.243847772, 0.239908256, 0.229889878, 0.209755184, 0.222822466, 0.232042951, 0.235729664, 0.247426623, 0.258704021, 0.254591535, 0.250198107, 0.263561656, 0.284279312, 0.301598858, 0.327603304, 0.344257118, 0.348942273, 0.37004693, 0.402372757, 0.42999598, 0.458031178, 0.494665763, 0.476924069, 0.472358556, 0.451926653, 0.446699734, 0.447367779, 0.476207719, 0.488607513, 0.557716737, 0.615817137, 0.672678787, 0.718748112, 0.762835853, 0.765492466, 0.799476881, 0.754109762, 0.750513427, 0.731536414, 0.724075087, 0.679595172, 0.712385983, 0.715200991, 0.743147541, 0.804334419, 0.819086117, 0.824040289, 0.829770064, 0.837927979, 0.804492801, 0.851634284, 0.853415671, 0.910797295, 0.900890456, 0.881259352, 0.843259903, 0.838659879, 0.789731766, 0.774484366, 0.786987397, 0.769343739, 0.799309469, 0.788468204, 0.772705926, 0.749749245, 0.773694326, 0.774524547, 0.821001224, 0.842131767, 0.847368667, 0.833782505, 0.785812859, 0.745718982, 0.732425025, 0.748912227, 0.818250619, 0.916081822, 0.940169199, 0.913976483, 0.91722057, 0.862123211, 0.805756144, 0.849424961, 0.879952352, 0.844256643, 0.820866943, 0.782653097, 0.671881594, 0.67434115, 0.681424673, 0.668249305, 0.664104439, 0.678395483, 0.688771305, 0.687306299, 0.698775129, 0.681305679, 0.661912074, 0.651383287, 0.69762869, 0.758853247, 0.791749903, 0.799459755, 0.786174418, 0.741896728, 0.685293808, 0.690429116, 0.709844594, 0.673776026, 0.641451623, 0.659489478, 0.638846236, 0.618683852, 0.638148107, 0.647776177, 0.601985221, 0.592096524, 0.608435999, 0.60524522, 0.615910316, 0.636525539, 0.628782777, 0.644276539, 0.702462143, 0.731279669, 0.762737116, 0.799940375, 0.779056089, 0.747193557, 0.736262098, 0.719281165, 0.748654315, 0.764007113, 0.766293792, 0.73986132, 0.702501251, 0.638241707, 0.647754868, 0.675743484, 0.684381298, 0.697130772, 0.714535267, 0.72187185, 0.721292594, 0.756313272, 0.758775704, 0.765005142, 0.723201322, 0.692537585, 0.668454984, 0.677483725, 0.671087983, 0.733749368, 0.754405332, 0.780089188, 0.76976058, 0.79142226, 0.785197914, 0.870577001, 0.969887202, 1.078589641, 1.076080438, 1.04213664, 1.005901, 0.923282259, 0.876326907, 0.925039967, 0.957049314, 0.921874539, 0.929376406, 0.883979064, 0.869087036, 0.932420499, 0.932812409, 0.930622463, 0.963428152, 0.987695586, 1.004760925, 1.091916446, 1.120455056, 1.182358462, 1.250356621, 1.23916443, 1.199858693, 1.230132034, 1.273020046, 1.274289475, 1.288186777, 1.297713255, 1.315102741, 1.280278813, 1.279824122, 1.3852509, 1.4254216, 1.387816806, 1.380748472, 1.435708983, 1.3495812, 1.320404573, 1.380377299, 1.421810411, 1.34278432, 1.390625037, 1.477475472, 1.535586315, 1.584691178, 1.625397311, 1.61006786, 1.57252993, 1.545605963, 1.492524189, 1.486240121, 1.482465289, 1.508028869, 1.531222192, 1.547545009, 1.609651327, 1.658448174, 1.698628004, 1.662926139, 1.708649424, 1.701875785, 1.744207831, 1.744357214, 1.793202993, 1.745003139, 1.728276467, 1.704045179, 1.756644667, 1.742057383, 1.735059156, 1.645765726, 1.58309315, 1.457219305, 1.448316043, 1.494044627, 1.621058923, 1.653815647, 1.638662826, 1.671051131, 1.619099677, 1.526723886, 1.481107497, 1.488881385, 1.432726476, 1.447726466, 1.532179262, 1.703440275, 1.796780978, 1.872658397, 2.012944447, 2.008091621, 1.839022335, 1.773014762, 1.74185253, 1.643250555, 1.646323391, 1.642893509, 1.710348413, 1.752647265, 1.868903581, 1.870534561, 1.911703917, 1.937784814, 1.968819597, 1.80370159, 1.796548728, 1.938894469, 2.000297263, 1.960976653, 2.006371564, 1.994084106, 1.912124295, 1.841514494, 1.889648599, 1.978232205, 2.085355801, 1.979048232, 1.885268339, 1.785676668, 1.677038342, 1.637890412, 1.793621207, 1.913760854, 2.000871462, 2.087826566, 2.045503931, 1.962563278, 1.877602439, 1.79342685, 1.741120047, 1.765282081, 1.805564651, 2.023694294, 2.106661514, 2.088921395, 2.150892436, 2.262465442, 2.099268002, 2.060811016, 2.170198126, 2.195577929, 2.0664519, 2.032654813, 2.108061305, 2.142239259, 2.068492439, 2.175615283, 2.334792646, 2.330314528, 2.360180918, 2.483875334, 2.408138484, 2.328428459, 2.451925247, 2.455150797, 2.585697701, 2.648135511, 2.590393765, 2.49649886, 2.445079477, 2.279213648, 2.372533537, 2.499576097, 2.48318701, 2.504888301, 2.504609237, 2.293962279, 2.274095491, 2.292080873, 2.292866321, 2.267477083, 2.398103192, 2.405746998, 2.505737158, 2.546757278, 2.622251055, 2.6049412, 2.531820128, 2.414587696, 2.381296352, 2.277315838, 2.31170748, 2.404743033, 2.525504529, 2.701303883, 2.83120101, 3.000091977, 3.12925432, 3.046336316, 2.875461732, 2.79419801, 2.740162621, 2.845168266, 2.987650847, 3.116998025, 3.264775646, 3.26340931, 3.23805596, 3.211856471, 3.075427477, 3.076357865, 3.168650964, 3.061876274, 3.122397966, 3.325991773, 3.184767768, 2.902513893, 2.759844004, 2.708722587, 2.713098849, 2.835780456, 3.08657002, 3.397625803, 3.328133658, 3.166028845, 3.145653104, 3.077636513, 2.804819041, 2.899360681, 3.065340859, 3.14228282, 3.073938485, 3.035192051, 2.908497952, 2.763617428, 2.63944202, 2.752038168, 2.943305768, 2.939821154, 2.987940382, 3.146214947, 3.142665169, 3.229918525, 3.384049101, 3.364130086, 3.216856264, 3.147765235, 2.897215497, 2.806238852, 2.925153286, 3.067264116, 3.324300097, 3.382591085, 3.354715267, 3.146889777, 3.111217232, 3.043769406, 3.14477026, 3.007294239, 3.043704721, 3.023799052, 2.976732222, 3.119044711, 3.325464246, 3.305865668, 3.167150734, 2.985377845, 2.758937527, 2.692154737, 2.704846768, 2.780804407, 2.773160426, 2.833783929, 3.049187696, 3.395957415, 3.411301832, 3.469318601, 3.575779273, 3.428976116, 3.281302512, 3.424644387, 3.500221377, 3.365909383, 3.341805179, 3.478382295, 3.413839465, 3.40647687, 3.549090414, 3.665776039, 3.426819688, 3.421030339, 3.369196824, 3.421728371, 3.523861344, 3.575955686, 3.500469681, 3.503138009, 3.379344245, 3.23324975, 3.178114813, 3.310794787, 3.394992454, 3.295057125, 3.344461974, 3.43305181, 3.490753264, 3.522663186, 3.773945124, 3.981697198, 4.099574209, 4.141812482, 4.038467938, 3.876717035, 3.528054697, 3.307650132, 3.306856104, 3.305463589, 3.241572816, 3.188687025, 3.192007124, 2.982349463, 2.907612461, 2.922625329, 3.025774842, 3.161349078, 3.205404274, 3.498980264, 3.632116699, 3.978221677, 4.24714388, 4.621328991, 4.778413571, 4.791648429, 4.628984557, 4.562374926, 4.476805503, 4.587947698, 4.782024864, 5.012754987, 5.174145855, 5.596336434,
    };
// @formatter:on

void FFT_task(void *argument);
void window_gen(float *out, u16 wind_size);

void FFT_init(fft_stuff_t *fft)
    {
    arm_rfft_fast_init_f32(&fft->fft_20.S, FFT_20KHZ_SIZE); //функция инициализации необходима для БФП
    window_gen(fft->fft_12.fft_window, FFT_12KHZ_SIZE);
    arm_rfft_fast_init_f32(&fft->fft_12.S, FFT_12KHZ_SIZE); //функция инициализации необходима для БФП
    window_gen(fft->fft_3.fft_window, FFT_3KHZ_SIZE);
    arm_rfft_fast_init_f32(&fft->fft_3.S, FFT_3KHZ_SIZE); //функция инициализации необходима для БФП
    xTaskCreate(FFT_task, "fft", configMINIMAL_STACK_SIZE * 4, fft,
	    osPriorityNormal, NULL);
    fft->fft_q = xQueueCreate(1, sizeof(in_analog_data_t));
    }

//отправить данные с ADAU в ффт
void send_analog_data_from_isr(fft_stuff_t *fft, s16 in_data1, s16 in_data2,
	s16 in_data3)
    {
    BaseType_t xHigherPriorityTaskWoken;
    static u32 data_count = 0;

    static in_analog_data_t data;
    data.data1[data_count] = in_data1;
    data.data2[data_count] = in_data2;
    data.data3[data_count++] = in_data3;

    if (data_count == FFT_DIV)
	{
	LD2_GPIO_Port->ODR |= LD2_Pin;
	data_count = 0;
	xQueueSendFromISR(fft->fft_q, &data, &xHigherPriorityTaskWoken);
	portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
	LD2_GPIO_Port->ODR &= ~ LD2_Pin;
	}
    }

void buf_data_add(float *data, s16 *in, u32 fft_size)
    {
    for (u32 i = 0; i < fft_size - FFT_DIV; i++)
	{
	data[i] = data[i + FFT_DIV];
	}
    for (u32 i = 0; i < FFT_DIV; i++)
	{
	data[i + fft_size - FFT_DIV] = (float) in[i];
	}
    }

void Decimation(s16 *in, float *out, u16 in_size, u16 out_size, u8 dec_order)
    {
    u32 new_dot_n = in_size / dec_order; //сколько новых семплов после децимации
    for (u32 i = 0; i < out_size - new_dot_n; i++) //сдвигаем старые данные
	{
	out[i] = out[i + new_dot_n];
	}
    for (volatile u32 i = 0; i < new_dot_n; i++)
	{
	float sum = 0;
	for (u8 j = 0; j < dec_order; j++) //вычисляем децимацию
	    {
	    sum = sum + ((float) in[i * dec_order + j]);
	    }
	out[i + out_size - new_dot_n] = sum / dec_order;
	}
    }

void delay(void)
    {
    LD2_GPIO_Port->ODR &= ~ LD1_Pin;
    for (volatile u8 i = 0; i < 0xAF; i++)
	;
    LD2_GPIO_Port->ODR |= LD1_Pin;
    }

void window_gen(float *out, u16 wind_size)
    {
    for (u32 i = 0; i < wind_size; i++)
	{
	if (i != (wind_size / 2))
	    {
	    out[i] = (sin((2 * PI * i) / wind_size - PI))
		    / ((2 * PI * i) / wind_size - PI);
	    }
	else
	    {
	    out[i] = 1.0f;
	    }
	}
    }

void window_func(float *in, float *out, float *k, u16 wind_size)
    {
    for (u32 i = 0; i < wind_size; i++)
	{
	out[i] = in[i] * k[i];
	}
    }

void fft_20_calc(fft_stuff_t *fft)
    {
    buf_data_add(fft->fft_20.fft_buf, fft->in_data.data1,
    FFT_20KHZ_SIZE);
    memcpy(fft->fft_20.fft_in, fft->fft_20.fft_buf, sizeof(fft->fft_20.fft_in));
    arm_rfft_fast_f32(&fft->fft_20.S, fft->fft_20.fft_in, fft->fft_20.fft_out,
	    0); //выполнение БФП
    arm_cmplx_mag_f32(fft->fft_20.fft_out, fft->fft_20.fft_res,
    FFT_20KHZ_SIZE); //вычисляем амплитуды гармоник
    for (u32 i = 0; i < FFT_20KHZ_SIZE / 2; i++)
	{
	fft->fft_20.fft_res[i] = fft->fft_20.fft_res[i] * linear_20KHZ[i];
	}
    }

void fft_12_calc(fft_stuff_t *fft)
    {
    Decimation(fft->in_data.data2, fft->fft_12.fft_buf, FFT_DIV,
    FFT_12KHZ_SIZE, 2);
    window_func(fft->fft_12.fft_buf, fft->fft_12.fft_in, fft->fft_12.fft_window,
    FFT_12KHZ_SIZE);
    arm_rfft_fast_f32(&fft->fft_12.S, fft->fft_12.fft_in, fft->fft_12.fft_out,
	    0); //выполнение БФП
    arm_cmplx_mag_f32(fft->fft_12.fft_out, fft->fft_12.fft_res,
    FFT_12KHZ_SIZE); //вычисляем амплитуды гармоник
    for (u32 i = 0; i < FFT_12KHZ_SIZE / 2; i++)
	{
	fft->fft_12.fft_res[i] = fft->fft_12.fft_res[i] * linear_12KHZ[i];
	}
    }

void fft_3_calc(fft_stuff_t *fft)
    {
    Decimation(fft->in_data.data3, fft->fft_3.fft_buf, FFT_DIV,
    FFT_3KHZ_SIZE, 8);
    window_func(fft->fft_3.fft_buf, fft->fft_3.fft_in, fft->fft_3.fft_window,
    FFT_3KHZ_SIZE);
//    memcpy(fft->fft_3.fft_in, fft->fft_3.fft_buf, sizeof(fft->fft_3.fft_in));
    arm_rfft_fast_f32(&fft->fft_3.S, fft->fft_3.fft_in, fft->fft_3.fft_out, 0); //выполнение БФП
    arm_cmplx_mag_f32(fft->fft_3.fft_out, fft->fft_3.fft_res,
    FFT_3KHZ_SIZE); //вычисляем амплитуды гармоник
    for (u32 i = 0; i < FFT_3KHZ_SIZE / 2; i++)
	{
	fft->fft_3.fft_res[i] = fft->fft_3.fft_res[i] * linear_3KHZ[i];
	}
    }

extern UART_HandleTypeDef huart3;
void FFT_task(void *argument)
    {
    u32 send_count = 0;
    fft_stuff_t *fft = (fft_stuff_t*) argument;
    for (;;)
	{
	if (xQueueReceive(fft->fft_q, &fft->in_data, 500) != pdFALSE)
	    {
	    LD2_GPIO_Port->ODR |= LD1_Pin;
	    fft_3_calc(fft);
	    delay();
	    fft_12_calc(fft);
	    delay();
	    fft_20_calc(fft);
	    LD2_GPIO_Port->ODR &= ~ LD1_Pin;
	    send_count++;
	    if (send_count == 94)
		{
		send_count = 0;
		//результат
		HAL_UART_Transmit(&huart3, (u8*) fft->fft_20.fft_res,
			sizeof(fft->fft_20.fft_res) / 2, 0xFFFFFFFF);
//		HAL_UART_Transmit(&huart3, (u8*) fft->fft_12.fft_res,
//			sizeof(fft->fft_12.fft_res) / 2, 0xFFFFFFFF);
//		HAL_UART_Transmit(&huart3, (u8*) fft->fft_3.fft_res,
//			sizeof(fft->fft_3.fft_res) / 2, 0xFFFFFFFF);
//		HAL_UART_Transmit(&huart3, (u8*) IIR_buf, sizeof(IIR_buf),
//			0xFFFFFFFF);

		}
	    }
	else
	    {

	    }
	}
    }

